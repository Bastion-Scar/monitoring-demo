#!/bin/bash
# setup.sh - Ð˜Ð½Ñ‚ÐµÑ€Ð°ÐºÑ‚Ð¸Ð²Ð½Ð°Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¾ÑˆÐ¸Ð±ÐºÐ¸
check_error() {
    local cmd="$@"
    eval "$cmd"
    if [ $? != 0 ]; then
        echo "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ð¸ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ '$cmd'." >&2
        exit 1
    fi
}

# Ð ÐµÐ³ÑƒÐ»ÑÑ€Ð½Ñ‹Ðµ Ð²Ñ‹Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ Ð´Ð»Ñ Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸
REGEX_TELEGRAM_TOKEN='^[0-9]{10}:.{35}$'
REGEX_TELEGRAM_CHAT_ID='^-?[0-9]+$'

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
if [ -f "config/tg.env" ]; then
    echo "ðŸš§ âš ï¸ Ð¤Ð°Ð¹Ð» 'tg.env' ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚!"
    read -rp "ÐŸÐµÑ€ÐµÐ·Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð»? (y/N): " overwrite_tg
    if [[ ! "${overwrite_tg}" =~ ^[Yy]$ ]]; then
        echo "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ñ„Ð°Ð¹Ð»Ð° tg.env Ð¾Ñ‚Ð¼ÐµÐ½ÐµÐ½Ð°."
    fi
else
    # Ð¡Ð±Ð¾Ñ€ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¾Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð´Ð»Ñ Telegram
    echo "ðŸ›  ðŸš€ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³-Ð´ÐµÐ¼Ð¾"
    echo "=========================================="

    echo "ðŸ“ž Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ Telegram Ð±Ð¾Ñ‚Ð°:"

    # ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¸ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð±Ð¾Ñ‚-Ñ‚Ð¾ÐºÐµÐ½Ð°
    while true; do
        read -rp "Telegram Bot Token: " bot_token
        if [[ -z "$bot_token" ]]; then
            echo "â— Ð‘Ð¾Ñ‚-Ñ‚Ð¾ÐºÐµÐ½ Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¿ÑƒÑÑ‚Ñ‹Ð¼!"
        elif ! [[ "$bot_token" =~ $REGEX_TELEGRAM_TOKEN ]]; then
            echo "â— ÐÐµÐ¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ñ‚Ð¾ÐºÐµÐ½Ð°! Ð¢Ð¾ÐºÐµÐ½ Ð´Ð¾Ð»Ð¶ÐµÐ½ ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ð½Ð¾ 'Ñ‡Ð¸ÑÐ»Ð¾:ÑÑ‚Ñ€Ð¾ÐºÐ°'. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÐµÑ‰Ñ‘ Ñ€Ð°Ð·."
        else
            break
        fi
    done

    # ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¸ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‡Ð°Ñ‚-ID
    while true; do
        read -rp "Telegram Chat ID: " chat_id
        if [[ -z "$chat_id" ]]; then
            echo "â— Ð§Ð°Ñ‚-ID Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¿ÑƒÑÑ‚Ñ‹Ð¼!"
        elif ! [[ "$chat_id" =~ $REGEX_TELEGRAM_CHAT_ID ]]; then
            echo "â— ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Chat ID! Ð”Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ñ†ÐµÐ»Ñ‹Ð¼ Ñ‡Ð¸ÑÐ»Ð¾Ð¼ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, '-12345'). ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÐµÑ‰Ñ‘ Ñ€Ð°Ð·."
        else
            break
        fi
    done

    # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð° tg.env
    cat > config/tg.env << EOF
# Telegram Bot Configuration
TELEGRAM_BOT_TOKEN="${bot_token}"
TELEGRAM_CHAT_ID="${chat_id}"
EOF

    check_error "cat config/tg.env"
    echo "âœ… Ð¤Ð°Ð¹Ð» 'tg.env' ÑÐ¾Ð·Ð´Ð°Ð½."
fi


# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð° db.env
if [ -f "config/db.env" ]; then
    echo "ðŸš§ âš ï¸ Ð¤Ð°Ð¹Ð» 'db.env' ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚!"
    read -rp "ÐŸÐµÑ€ÐµÐ·Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð»? (y/N): " overwrite_db
    if [[ ! "${overwrite_db}" =~ ^[Yy]$ ]]; then
        echo "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ñ„Ð°Ð¹Ð»Ð° db.env Ð¾Ñ‚Ð¼ÐµÐ½ÐµÐ½Ð°."
    fi
else
    # Ð¡Ð±Ð¾Ñ€ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð»Ñ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
    echo "ðŸ” Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ… MySQL:"

    # ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÐºÐ¾Ñ€Ð½Ñ Ð¿Ð°Ñ€Ð¾Ð»Ñ
    while true; do
        read -rp "MySQL Root Password: " MYSQL_ROOT_PASSWORD
        if [[ -z "$MYSQL_ROOT_PASSWORD" ]]; then
            echo "â— ÐŸÐ°Ñ€Ð¾Ð»ÑŒ Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¿ÑƒÑÑ‚Ñ‹Ð¼!"
        else
            break
        fi
    done

    # ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
    while true; do
        read -rp "ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ… (database): " MYSQL_DATABASE
        if [[ -z "$MYSQL_DATABASE" ]]; then
            echo "â— ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¿ÑƒÑÑ‚Ñ‹Ð¼!"
        else
            break
        fi
    done

    # ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ MySQL
    while true; do
        read -rp "ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ MySQL: " MYSQL_USER
        if [[ -z "$MYSQL_USER" ]]; then
            echo "â— Ð˜Ð¼Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¿ÑƒÑÑ‚Ñ‹Ð¼!"
        else
            break
        fi
    done

    # ÐŸÐ°Ñ€Ð¾Ð»ÑŒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ MySQL
    while true; do
        read -rp "ÐŸÐ°Ñ€Ð¾Ð»ÑŒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ MySQL: " MYSQL_PASSWORD
        if [[ -z "$MYSQL_PASSWORD" ]]; then
            echo "â— ÐŸÐ°Ñ€Ð¾Ð»ÑŒ Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð¿ÑƒÑÑ‚Ñ‹Ð¼!"
        else
            break
        fi
    done

    # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð° db.env
    cat > config/db.env << EOF
# MySQL Configuration
MYSQL_ROOT_PASSWORD="${MYSQL_ROOT_PASSWORD}"
MYSQL_DATABASE="${MYSQL_DATABASE}"
MYSQL_USER="${MYSQL_USER}"
MYSQL_PASSWORD="${MYSQL_PASSWORD}"
EOF

    check_error "cat config/db.env"
    echo "âœ… Ð¤Ð°Ð¹Ð» 'db.env' ÑÐ¾Ð·Ð´Ð°Ð½."

    # Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ ÑÑ‚Ñ€Ð¾ÐºÐ¸ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ (DSN) Ð´Ð»Ñ app.env
    DSN="${MYSQL_USER}:${MYSQL_PASSWORD}@tcp(db:3306)/${MYSQL_DATABASE}?charset=utf8mb4&parseTime=True&loc=Local"

    # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð° app.env
    cat > config/app.env << EOF
# App Configuration
DSN="${DSN}"
EOF

    check_error "cat config/app.env"
    echo "âœ… Ð¤Ð°Ð¹Ð» 'app.env' ÑÐ¾Ð·Ð´Ð°Ð½."
fi

# ÐŸÐ¾Ð´Ð½Ð¸Ð¼Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ Docker Compose
echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚..."
check_error "docker compose up -d"

exit 0